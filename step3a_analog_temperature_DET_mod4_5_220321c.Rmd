---
title: "Modeling Indoor Heat Health Impacts, Step 3a, Detroit"
author: "Carina Gronlund"
date: "March 21, 2022"
output:
  html_notebook:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r chunk setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=T, results='hide',cache=F)
```

Load necessary libraries and establish path and file names.
```{r chunk libs}
library(DiagrammeR) #see https://rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html
library(data.table)
library(rnoaa)
library(curl)
library(nlme)
library(sandwich)
library(car)

source('C:\\Users\\gronlund\\Dropbox (University of Michigan)\\DocumentsC\\NSF Stone\\Health Impact Function\\Programs\\paths_filenames.R')

load(paste0(pa2,fi2))
```

#Step 3a: Regress IET.daily on OAT.daily to get IET fitted values for each OAT temperature.
In this step, we estimate what an equivalent IET would be for any given OAT, or *outdoor analog temperature*, based on the historic relationship between airport temperature and IET when power is on. In turn, we can eventually use the one-to-one relationship between airport temperature and risk of mortality (or hospitalization, ED visit, or preterm birth) to estimate the risk for any given IET. Note that for occupation (OCC), 1 = indoor; 2 = outdoor; 3 = unemployed, and unemployed includes all children under 5 and adults 65 and older, while the remaining codes were derived using PUMS data and logistic regression (see SPD_Dictionary.pdf).

##Set up the data set.

First, recreate the merged IETs and characteristics file.
```{r chunk 3.1}
load(paste0(pa2,fi7))
load(paste0(pa2,fi42))
dat4<-merge(IET.daily.historic.DET[!is.na(IET.mean),.(date,PERSON_ID,IET.mean)],demographics.DET[,.(PERSON_ID,AGE,AC_STATUS,EP_CLASS,HH_INCOME,OCC,SEX,GRID_2010_L2)],by='PERSON_ID',all.x=T)
```
IET ranges from 8-30.6 C.

Merge in airport temperature.
```{r chunk 3.2}
dat4[,date:=as.Date(date)] #convert dat4$date to a date class
dat4<-merge(dat4,APT.daily[['DET']][,.(date,tempC_mean)],by='date',all.x=T)
```
tempC_mean ranges from 18.3 to 30.4 C.

Order dat4 in a consistent way so that the output from the models can be matched to their respective rows in dat4.
```{r chunk 3.4}
dat4<-dat4[order(PERSON_ID,date),]
```

Convert IET.mean from tenths of degrees Fahrenheit to Celsius.
```{r chunk 3.4b}
dat4[,IETmean:=(IET.mean/10-32)/1.8]
```

Clean up to save space.
```{r clean1}
rm(demographics.DET,IET.daily.historic.DET)
```

##Model 4
See previous code for models 1-3, which were much more complicated.

Regress daily mean IET on daily mean airport temperature (tempC_mean) overall.
```{r chunk 3.5, results='show'}
start<-Sys.time()
mod4.DET.overall<-lm(IETmean~tempC_mean, data=dat4)
end<-Sys.time()
cat('Runtime: ')
end-start
summary(mod4.DET.overall)
cat('\ncorrelation:',dat4[,cor(IETmean,tempC_mean)])
```

Runtime: Time difference of 9.403604 secs

Call:
lm(formula = IETmean ~ tempC_mean, data = dat4)

Residuals:
     Min       1Q   Median       3Q      Max 
-14.7302  -1.4052   0.7435   2.2966   7.7674 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) 1.208e+01  8.790e-03    1374   <2e-16 ***
tempC_mean  3.952e-01  3.354e-04    1178   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 3.476 on 6978068 degrees of freedom
Multiple R-squared:  0.1659,	Adjusted R-squared:  0.1659 
F-statistic: 1.388e+06 on 1 and 6978068 DF,  p-value: < 2.2e-16


correlation: 0.4073541

Look at results.
```{r mod4-results,results='show'}
summary(mod4.DET.overall)
rm(mod4.DET.overall)
```
R^2 is 0.1659, which is not great. The coefficient is 0.3952, which means that for each degree C increase in outdoor temperature, indoor temperature increases by 0.3952 degrees, on average.

Regress daily mean IET and daily mean airport temperature (tempC_mean) overall with a random intercept per person.

```{r chunk 3.5a, results='show'}
start<-Sys.time()
mod4.DET.rint<-lme(IETmean~tempC_mean, random=~1|PERSON_ID,data=dat4,keep.data=F)
end<-Sys.time()
cat('Runtime: ')
end-start
```

Look at results for this model.
```{r chunk 3.5v, results='show'}
summary(mod4.DET.rint)
cat('\nICC:',ICC.fxn(mod4.DET.rint))
```
The standard deviation of the residuals (sigma) is low (3.47 C) and that of the random intercepts (tau) is very low (0.000299). The ICC is almost 0, suggesting that random effects are not needed. The AIC is 37189737. Because we included random intercepts in the Phoenix model, we will attempt to do so here going forward.

##Model 5
What are the major drivers of IET in these models: AGE vs. AC_STATUS vs. EP_CLASS vs. HH_INCOME vs. OCC vs. SEX?

First, standardize variables in the data set and create a housing class variable.
```{r chunk 3.30}
dat5<-varDeriv.fxn.DET(dat4)
dat5[,c('AGE','AC_STATUS','EP_CLASS','OCC','SEX','tempC_mean','IET.mean','IETmean'):=NULL]
#rm(dat4)
```

Then, perform linear regression of standardized IET.mean on standardized airport temperature and each variable as well as interactions with airport temperature.
```{r chunk 3.31}
mod5.DET<-lm(IETmeanS~APTmeanS*(ageS+age2+lnIncomeS+lnIncome2+maleS+OCC2+OCC3+PAC+NAC+MF_06N+MF_06S+MF_12N+MF_12S+SF2M+SF2M_B+SF2M_S+SF2M_SB+SF2NM+SF2NM_B+SF2NM_S+SF2NM_SB+SFM+SFM_S+SFNM_S), data=dat5)
```

Look at model results.
```{r chunk 3.32, results='show'}
summary(mod5.DET)
cat('AIC:',AIC(mod5.DET))
```
This AIC of 17692138 is lower than for the random intercept model, so there is something gained by including these terms. The R^2 is 0.18.

Save the model results.
```{r chunk lm-save}
#models.DET<-list()
models.DET[['coef.lm.scaled']]<-coef(mod5.DET)
models.DET[['vcov.lm.scaled']]<-vcov(mod5.DET)
save(models.DET,file=paste0(pa2,fi45))
```


What are the variance inflation factors for this model?
```{r chunk 3.35, results='show'}
vif(mod5.DET)
```
The VIFs are all less than 5, except APTmeanS:age2 which has a vif of 5.4, and all definitely less than 10, so we do not have concerns about multi-collinearity here.

Model with sandwich (robust) errors.
```{r chunk 42, results='show'}
se.lm<-sqrt(diag(sandwich(mod5.DET)))
dat1<-data.frame(coef=coef(mod5.DET),SE=se.lm)
dat1$t<-dat1$coef/dat1$SE
dat1$p<-2*pnorm(abs(dat1$t),lower.tail=F)
dat1
```
Qualitatively, the SEs were similar, although some that are borderline significant in one are not in the lm model.

How does the random effects model compare with the regular model? Note: this model took 13 minutes to run.
```{r chunk 39, results='show'}
start.time<-Sys.time()
mod5.DET.re<-lme(IETmeanS~APTmeanS*(ageS+age2+lnIncomeS+lnIncome2+maleS+OCC2+OCC3+PAC+NAC+MF),random=~1|PERSON_ID,keep.data=F,data=dat5)
end.time<-Sys.time()
summary(mod5.DET.re)
```
The slopes for the age terms are not significant, and for the intercept, their contribution is very small, with t values < 10. The AIC of 17758769 is larger than 17692138, so model fit is worse than when we included the housing terms beyond MF vs. SF, despite adding a random intercept..

Run a model that does not include AC, which was modeled using many of the other variables in the model, or grid, which is not useful for predictions outside of this study.
```{r chunk-mod10-reduced, results='show'}
mod5.10<-lm(IETmeanS~APTmeanS*(ageS+age2+lnIncomeS+lnIncome2+maleS+OCC2+OCC3+MF), data=dat5)
summary(mod5.10)
AIC(mod5.10)
```
Even without AC, income is still in the unexpected direction, although only slightly so. Housing is the biggest driver of slope in Detroit, followed by occupation and gender.

Save the model results.
```{r chunk lm-save-simple}
#models.DET<-list()
models.DET[['coef.lm.reduced.scaled']]<-coef(mod5.10)
models.DET[['vcov.lm.reduced.scaled']]<-vcov(mod5.10)
save(models.DET,file=paste0(pa2,fi45))
```

Try a random intercept model with an even more reduced model omitting both age and air conditioning, consistent with the terms in the Phoenix model. This took 8 minutes to run.
```{r mod-ran-int-reduced-more}
start.time<-Sys.time()
mod5.12<-lme(IETmeanS~APTmeanS*(lnIncomeS+lnIncome2+maleS+OCC2+OCC3+MF), random=~1|PERSON_ID, data=dat5)
end.time<-Sys.time()
```

Look at results.
```{r chunk-mod-ran-int-summary, results='show'}
summary(mod5.12)
```
The AIC is 17793260, which is similar thought slightly higher than that for mod5.10. The variables are all highly significant. For income, for those above \$30,000, IET increases more quickly for each deg C of APT than for those at the mean. For those below \$30,000, IET increases more slowly with each degree of C, i.e., the total slope is less than 0.21. Even in a crude linear regression model, not accounting for occupation or the other characteristics, the APTmeanS*lnIncomeS slope is still positive. This is counter-intuitive, as we would expect those with higher incomes to be less affected by outdoor temperature. Nevertheless, occupation is in the expected direction, with outdoor workers' IETs rising more quickly with rising APT. Income may be most strongly correlated with one's ability to leave the home in Detroit rather than AC usage or access to cool spaces.

Save the model results.
```{r chunk-lm-save-ran.int}
#models.DET<-list()
models.DET[['coef.lm.reduced.rint.scaled']]<-mod5.12$coefficients$fixed
models.DET[['vcov.lm.reduced.rint.scaled']]<-mod5.12$varFix
models.DET[['rint.lm.reduced.rint.scaled']]<-setNames(mod5.12$coefficients$random$PERSON_ID,row.names(mod5.12$coefficients$random$PERSON_ID))
models.DET[['tau.sigma.lm.reduced.rint.scaled']]<-c(3.783365e-05,0.8658777) #note that the tau (random effects) and sigma (residuals) SDs were computed on the log(sd) scale (see https://stats.idre.ucla.edu/r/faq/how-can-i-calculate-standard-errors-for-variance-components-from-mixed-models/)
save(models.DET,file=paste0(pa2,fi45))
```

Try running the random intercept model with the housing terms added back. This took 16 minutes.
```{r chunk-rint-housing}
start.time<-Sys.time()
mod5.13<-lme(IETmeanS~APTmeanS*(lnIncomeS+lnIncome2+maleS+OCC2+OCC3+MF_06N+MF_06S+MF_12N+MF_12S+SF2M+SF2M_B+SF2M_S+SF2M_SB+SF2NM+SF2NM_B+SF2NM_S+SF2NM_SB+SFM+SFM_S+SFNM_S), random=~1|PERSON_ID, data=dat5)
end.time<-Sys.time()
```

Look at results.
```{r chunk-rint-housing-results}
summary(mod5.13)
```
The following main effects are not significant: SF2M_SB, SF2NM_S, SFM_S and the following interactions are not significant: APTmeanS:SF2M_S, APTmeanS, SF2NM_S. The AIC, 17727127, is lower than the mod5.12, which had a simplified MF vs. SF categorization of housing. This AIC is higher than the lm model with all these terms + the age terms, but the coefficients for both the main effects of age and their interactions with APTmeanS are very small, so we will exclude them here as we did for Phoenix.

Save the model results.
```{r chunk-lm-save-ran.int-housing}
#models.DET<-list()
models.DET[['coef.lm.reduced.housing.rint.scaled']]<-mod5.13$coefficients$fixed
models.DET[['vcov.lm.reduced.housing.rint.scaled']]<-mod5.13$varFix
models.DET[['rint.lm.reduced.housing.rint.scaled']]<-setNames(mod5.13$coefficients$random$PERSON_ID,row.names(mod5.13$coefficients$random$PERSON_ID))
models.DET[['tau.sigma.lm.reduced.housing.rint.scaled']]<-c(6.912959e-05, 0.8617669)
save(models.DET,file=paste0(pa2,fi45))
```

Collapse the housing categories as follows based on phone call with Brian 21-11-19: shaded SF 1 story, unshaded SF 1 story, shaded SF 2 story basement, unshaded SF2 story basenebt, shaded SF 2 story no basement, unshaded SF 2 story no basement, MF for Detroit. Note that adding the mean-centered variables together creates a new mean-centered variable, because 1-a/T + 0-b/T = 1-(a+b)/T, 0-a/T + 1-b/T = 1-(a+b)/T, and 0-a/T + 0-b/T = 0-(a+b)/T.

Because no women have outdoor occupations in this data set, we create male-indoor, female-indoor (reference), outdoor, male-unemployed, and female-unemployed categories.

```{r collapse-housing}
dat5<-varDeriv.fxn2.DET(dat5)
```

Try a random intercept model with the reduced housing terms. This took 5 minutes to run.
```{r chunk-mod-ran-int-reduced-redhousing}
start.time<-Sys.time()
mod5.14<-lme(IETmeanS~APTmeanS*(lnIncomeS+lnIncome2+male_OCC1+male_OCC3+female_OCC3+MF+SF_S+SF2_SB+SF2_B+SF2_S+SF2+NAC+PAC), random=~1|PERSON_ID, data=dat5)
end.time<-Sys.time()
```

Look at results.
```{r chunk-mod-ran-int-summary-redhousing, results='show'}
summary(mod5.14)
```
The AIC, 17730108, is higher than the previous model that had unsimplified housing terms.

Save the model results.
```{r chunk-lm-save-ranint-redhousing}
models.DET[['coef.lm.reduced.redhousing.rint.scaled']]<-mod5.14$coefficients$fixed
models.DET[['vcov.lm.reduced.redhousing.rint.scaled']]<-mod5.14$varFix
models.DET[['rint.lm.reduced.redhousing.rint.scaled']]<-setNames(mod5.14$coefficients$random$PERSON_ID,row.names(mod5.14$coefficients$random$PERSON_ID))
models.DET[['tau.sigma.lm.reduced.redhousing.rint.scaled']]<-exp(attributes(mod5.14$apVar)$Par)
save(models.DET,file=paste0(pa2,fi45))
```

Redefine the variables so that it's easier to figure out the values for individual combos of housing.
```{r}
dat5[,MF:=as.integer(MF>0)]
dat5[,SF_S:=as.integer(SF_S>0)]
dat5[,SF:=as.integer(SF>0)]
dat5[,SF2_SB:=as.integer(SF2_SB>0)]
dat5[,SF2_B:=as.integer(SF2_B>0)]
dat5[,SF2_S:=as.integer(SF2_S>0)]
dat5[,SF2:=as.integer(SF2>0)]
dat5[,lowAC:=as.integer(lowAC>0)]
```


Try a random intercept model with the reduced housing terms and interactions with AC. This took 25 minutes to run.
```{r chunk-mod-ran-int-red-redhousing}
start.time<-Sys.time()
mod5.15<-lme(IETmeanS~APTmeanS*(lnIncomeS+lnIncome2+male_OCC1+OCC2+male_OCC3+female_OCC3+(MF+SF_S+SF2_SB+SF2_B+SF2_S+SF2)*lowAC), random=~1|PERSON_ID, data=dat5)
end.time<-Sys.time()
```

Look at results.
```{r chunk-mod-ran-int-summary-red-redhousing, results='show'}
summary(mod5.15)
```
lowAC is still producing cooler temperatures than hiAC and producing slower rates of change of IET with OAT than hi AC. This is completely counterintuitive. Therefore, we will use a model without AC.

Save the model results.
```{r chunk-lm-save-ranint-redhousing-lowAC}
models.DET[['coef.lm.red.redhousing.lowAC.rint.scaled']]<-mod5.15$coefficients$fixed
models.DET[['vcov.lm.red.redhousing.lowAC.rint.scaled']]<-mod5.15$varFix
models.DET[['rint.lm.red.redhousing.lowAC.rint.scaled']]<-setNames(mod5.15$coefficients$random$PERSON_ID,row.names(mod5.15$coefficients$random$PERSON_ID))
models.DET[['tau.sigma.lm.red.redhousing.lowAC.rint.scaled']]<-exp(attributes(mod5.15$apVar)$Par)
save(models.DET,file=paste0(pa2,fi45))
```

Rescale the variables so that everything is mean-centered again.
```{r collapse-housing3}
dat5<-varDeriv.fxn2.DET(dat5)
```

Re-run with income categories. This took 17 minutes to run.

```{r chunk-mod-ran-int-red-redhousing-noAC}
start.time<-Sys.time()
mod5.16<-lme(IETmeanS~APTmeanS*(inclt15+inc15_30+inc30_50+inc50_75+male_OCC1+OCC2+male_OCC3+female_OCC3+MF+SF_S+SF2_SB+SF2_B+SF2_S+SF2), random=~1|PERSON_ID, data=dat5)
end.time<-Sys.time()
```

Look at results.
```{r chunk-mod-ran-int-summary-red-redhousing-noAC, results='show'}
summary(mod5.16)
```

Save the model results.
```{r chunk-lm-save-ranint-redhousing-noAC}
models.DET[['coef.lm.inccat.redhousing.noAC.rint.scaled']]<-mod5.16$coefficients$fixed
models.DET[['vcov.lm.inccat.redhousing.noAC.rint.scaled']]<-mod5.16$varFix
models.DET[['rint.lm.inccat.redhousing.noAC.rint.scaled']]<-setNames(mod5.16$coefficients$random$PERSON_ID,row.names(mod5.16$coefficients$random$PERSON_ID))
models.DET[['tau.sigma.lm.inccat.redhousing.noAC.rint.scaled']]<-exp(attributes(mod5.16$apVar)$Par)
save(models.DET,file=paste0(pa2,fi45))
```

Given the low tau, re-run with just linear regression.
```{r}
start.time<-Sys.time()
mod5.17<-lm(IETmeanS~APTmeanS*(inclt15+inc15_30+inc30_50+inc50_75+male_OCC1+OCC2+male_OCC3+female_OCC3+MF+SF_S+SF2_SB+SF2_B+SF2_S+SF2), data=dat5)
end.time<-Sys.time()
summary(mod5.17)
```

Call:
lm(formula = IETmeanS ~ APTmeanS * (inclt15 + inc15_30 + inc30_50 + 
    inc50_75 + male_OCC1 + OCC2 + male_OCC3 + female_OCC3 + MF + 
    SF_S + SF2_SB + SF2_B + SF2_S + SF2), data = dat5)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.5503 -0.3570  0.1904  0.5720  1.8162 

Coefficients:
                       Estimate Std. Error  t value Pr(>|t|)    
(Intercept)           0.0888985  0.0003272  271.705  < 2e-16 ***
APTmeanS              0.3950824  0.0003335 1184.522  < 2e-16 ***
inclt15              -0.0347836  0.0011415  -30.473  < 2e-16 ***
inc15_30             -0.0336555  0.0011605  -29.000  < 2e-16 ***
inc30_50             -0.0226969  0.0011382  -19.941  < 2e-16 ***
inc50_75             -0.0162801  0.0012188  -13.357  < 2e-16 ***
male_OCC1             0.0009138  0.0008343    1.095 0.273345    
OCC2                 -0.0124047  0.0011304  -10.974  < 2e-16 ***
male_OCC3             0.0114022  0.0012505    9.118  < 2e-16 ***
female_OCC3           0.0048886  0.0011184    4.371 1.24e-05 ***
MF                    0.1433109  0.0009261  154.746  < 2e-16 ***
SF_S                 -0.1330905  0.0037450  -35.538  < 2e-16 ***
SF2_SB               -0.0970271  0.0071066  -13.653  < 2e-16 ***
SF2_B                 0.0351268  0.0008117   43.275  < 2e-16 ***
SF2_S                 0.0050900  0.0138997    0.366 0.714218    
SF2                   0.1625592  0.0015174  107.127  < 2e-16 ***
APTmeanS:inclt15     -0.0363760  0.0011636  -31.261  < 2e-16 ***
APTmeanS:inc15_30    -0.0359952  0.0011831  -30.426  < 2e-16 ***
APTmeanS:inc30_50    -0.0324201  0.0011603  -27.942  < 2e-16 ***
APTmeanS:inc50_75    -0.0104745  0.0012425   -8.430  < 2e-16 ***
APTmeanS:male_OCC1   -0.0150128  0.0008504  -17.653  < 2e-16 ***
APTmeanS:OCC2         0.0336493  0.0011523   29.202  < 2e-16 ***
APTmeanS:male_OCC3    0.0083166  0.0012748    6.524 6.85e-11 ***
APTmeanS:female_OCC3  0.0041065  0.0011402    3.602 0.000316 ***
APTmeanS:MF          -0.1657437  0.0009441 -175.561  < 2e-16 ***
APTmeanS:SF_S         0.0338726  0.0038177    8.872  < 2e-16 ***
APTmeanS:SF2_SB       0.0550891  0.0072445    7.604 2.87e-14 ***
APTmeanS:SF2_B       -0.0774883  0.0008275  -93.645  < 2e-16 ***
APTmeanS:SF2_S        0.0001750  0.0141695    0.012 0.990145    
APTmeanS:SF2         -0.1428522  0.0015469  -92.348  < 2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.864 on 6978040 degrees of freedom
Multiple R-squared:  0.1754,	Adjusted R-squared:  0.1754 
F-statistic: 5.119e+04 on 29 and 6978040 DF,  p-value: < 2.2e-16


